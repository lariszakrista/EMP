set "-e"

if [ $# != 1 ]; then
    echo "Must pass image_dir as argument"
    exit
fi

BASE_DIR=$(cd $1 && pwd)
SRC_IMG_BUCKET=eclipse_image_ground_truth_dataset_renamed
SRC_IMG_DIR=$BASE_DIR/$SRC_IMG_BUCKET
SRC_IMG_FILE=$SRC_IMG_DIR/images.txt
OUTPUT_DIR=$BASE_DIR/output

mkdir $SRC_IMG_DIR
echo "Saving images from GCS to $SRC_IMG_DIR..."
gsutil cp "gs://$SRC_IMG_BUCKET/*" $SRC_IMG_DIR
cat $SRC_IMG_DIR/image_data.txt | cut -d "|" -f 1 > $SRC_IMG_FILE

echo "Running image processor..."
mkdir $OUTPUT_DIR
pushd ../../src/imgproc/cpp
make clean
make
./imgproc_batch $SRC_IMG_FILE $SRC_IMG_DIR $OUTPUT_DIR
popd

python3 image_proc_output.py $SRC_IMG_DIR $OUTPUT_DIR $OUTPUT_DIR
google-chrome $OUTPUT_DIR/output.html
 
